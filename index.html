<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fermap Log√≠stica</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --p: #4285F4; --s: #34A853; --dark: #202124; --orange: #ed8936; --purple: #6b46c1; --red: #EA4335; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background: #f8f9fa; height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 420px; background: white; display: flex; flex-direction: column; box-shadow: 2px 0 12px rgba(0,0,0,0.1); z-index: 100; }
        .sidebar-header { padding: 20px; background: var(--dark); color: white; border-bottom: 4px solid var(--p); }
        
        .search-area { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 10px; font-weight: bold; color: #70757a; margin-bottom: 4px; text-transform: uppercase; }
        input { width: 100%; padding: 10px 15px; border: 1px solid #dadce0; border-radius: 8px; font-size: 13px; outline: none; }

        #stopList { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        .stop-item { background: white; border: 1px solid #dadce0; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: grab; display: flex; flex-direction: column; position: relative; }
        .stop-item.fixed-base { background: #e8f0fe; border-left: 5px solid var(--p); cursor: default; }
        .stop-item.fixed-end { background: #ffebee; border-left: 5px solid var(--red); cursor: default; }
        
        .stop-main { display: flex; align-items: center; width: 100%; }
        .stop-number { width: 24px; height: 24px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .stop-info { flex: 1; overflow: hidden; }
        .stop-info b { display: block; font-size: 13px; }

        .obs-edit-container { display: flex; margin-top: 8px; gap: 5px; align-items: center; }
        .input-obs-inline { flex: 1; font-size: 11px; padding: 6px; border: 1px dashed #ccc; border-radius: 4px; background: #fff; }
        .btn-save-obs { background: var(--s); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-del { border: none; background: none; color: var(--red); cursor: pointer; font-weight: bold; padding: 5px; position: absolute; top: 8px; right: 8px; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px 15px; border-bottom: 1px solid #eee; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; text-transform: uppercase; font-size: 11px; text-align: center; }
        .btn-opt { background: var(--orange); }
        .btn-invert { background: var(--purple); }
        .btn-csv { background: #718096; grid-column: span 2; }
        .btn-pdf { background: #E11D48; grid-column: span 2; }
        .btn-wa { background: #25D366; grid-column: span 2; font-size: 14px; margin-top: 5px; }

        #map { flex: 1; z-index: 1; position: relative; }
        
        /* Oculta painel nativo do Routing Machine */
        .leaflet-routing-container { display: none !important; }
        
        .leaflet-marker-icon { cursor: pointer !important; }

        .num-icon, .num-icon-end { border: 2px solid white; border-radius: 50%; color: white; font-weight: bold; text-align: center; line-height: 22px; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .num-icon { background: var(--p); }
        .num-icon-end { background: var(--red); }
        
        .custom-label { background: rgba(255, 255, 255, 0.95); border: 1px solid var(--p); border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #333; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; }

        #summary-card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 25px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 999;
            display: none; gap: 20px; align-items: center;
            font-family: 'Roboto', sans-serif; border: 2px solid var(--p);
        }
        .summary-item { display: flex; align-items: center; gap: 8px; }
        .summary-item i { color: var(--p); font-size: 20px; }
        .summary-text { display: flex; flex-direction: column; line-height: 1.2; }
        .summary-label { font-size: 9px; text-transform: uppercase; color: #777; font-weight: bold; }
        .summary-value { font-size: 16px; font-weight: bold; color: #333; }
        .divider { width: 1px; height: 25px; background: #ddd; }

        #loading { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 25px; border-radius: 30px; z-index: 9999; }
        
        /* Responsividade para Celular */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: 50%; order: 2; }
            #map { height: 50%; order: 1; }
            #summary-card { bottom: auto; top: 10px; width: 90%; justify-content: center; }
        }
    </style>
</head>
<body>

<div id="loading">‚åõ Calculando Rota...</div>

<div id="summary-card">
    <div class="summary-item">
        <i class="material-icons">directions_car</i>
        <div class="summary-text"><span class="summary-label">Dist√¢ncia</span><span class="summary-value" id="total-dist">0 km</span></div>
    </div>
    <div class="divider"></div>
    <div class="summary-item">
        <i class="material-icons">schedule</i>
        <div class="summary-text"><span class="summary-label">Tempo</span><span class="summary-value" id="total-time">0 min</span></div>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>Fermap Log√≠stica</h2>
        <p style="font-size: 11px; opacity: 0.8;">Gerenciador de Rotas</p>
    </div>

    <div class="search-area">
        <div class="input-group">
            <label>1. Endere√ßo (Busca Google)</label>
            <input type="text" id="addressSearch" placeholder="Digite o endere√ßo do cliente...">
        </div>
        <div class="input-group">
            <label>2. Coordenadas (Lat, Long)</label>
            <input type="text" id="coordsInput" placeholder="-0.034987, -51.074846">
        </div>
        <div id="confirmAdd" style="display: none; padding: 10px; background: #e8f0fe; border-radius: 8px; margin-top: 10px;">
            <input type="text" id="manualName" placeholder="Nome do Cliente">
            <input type="text" id="manualObs" placeholder="Observa√ß√£o">
            <button class="btn" style="background: var(--p); width: 100%;" onclick="confirmAddPoint()">Confirmar Adi√ß√£o</button>
        </div>
    </div>

    <div class="btn-grid">
        <button class="btn btn-opt" onclick="optimizeRouteWithReturn()">‚ú® Otimizar Rota</button>
        <button class="btn btn-invert" onclick="reverseMiddleRoute()">üîÑ Inverter (Meio)</button>
        <button class="btn btn-csv" onclick="document.getElementById('csvFile').click()">üìÅ Importar CSV</button>
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button class="btn btn-pdf" onclick="exportRouteToPDF()">üìÑ Gerar PDF</button>
        <button class="btn btn-wa" onclick="sendToWhatsApp()">üí¨ WhatsApp</button>
    </div>

    <div id="stopList"></div>
    <div style="padding: 10px 15px; border-top: 1px solid #ddd;">
        <button class="btn" style="background: #70757a; width: 100%; font-size: 10px;" onclick="resetMap()">Limpar Tudo</button>
    </div>
</div>

<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASqT7DnMM4756HZM5m7cMt-nE7eWMoi7Y&libraries=places"></script>

<script>
    // Configura√ß√µes Iniciais - Coordenadas da Fermap
    const baseCoords = { lat: 0.034987156301830635, lng: -51.074846156278724 };
    const fermapStart = { nome: "FERMAP (SA√çDA)", obs: "In√≠cio", lat: baseCoords.lat, lng: baseCoords.lng };
    const fermapEnd = { nome: "FERMAP (CHEGADA)", obs: "Fim", lat: baseCoords.lat, lng: baseCoords.lng };

    let map, routingControl, markers = [], points = [], tempCoord = null, lastRouteData = null;
    
    function cleanObs(text) { if (!text) return ""; return text.trim().replace(/^-+\s*/, ''); }

    function init() {
        // Camadas de Mapa
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' });
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri', maxZoom: 19 });
        const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB', maxZoom: 19 });

        map = L.map('map', { center: [baseCoords.lat, baseCoords.lng], zoom: 14, layers: [osm], zoomControl: false });

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.control.layers({ "üó∫Ô∏è Padr√£o": osm, "üõ∞Ô∏è Sat√©lite": satellite, "üåë Dark Mode": dark }).addTo(map);

        points = [fermapStart, fermapEnd];
        updateUI();

        // Autocomplete do Google
        const autocomplete = new google.maps.places.Autocomplete(document.getElementById('addressSearch'));
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry) return;
            tempCoord = [place.geometry.location.lat(), place.geometry.location.lng()];
            document.getElementById('manualName').value = place.name;
            document.getElementById('confirmAdd').style.display = 'block';
        });

        // Entrada Manual de Coordenadas
        document.getElementById('coordsInput').addEventListener('input', function(e) {
            const val = e.target.value;
            if (val.includes(',')) {
                const parts = val.split(',');
                const lat = parseFloat(parts[0].trim()), lng = parseFloat(parts[1].trim());
                if (!isNaN(lat) && !isNaN(lng)) {
                    tempCoord = [lat, lng];
                    document.getElementById('manualName').value = "Ponto por Coordenada";
                    document.getElementById('confirmAdd').style.display = 'block';
                    map.setView(tempCoord, 16);
                }
            }
        });

        // Drag and Drop da Lista
        Sortable.create(document.getElementById('stopList'), { animation: 150, filter: ".fixed-base, .fixed-end", onEnd: reorderPoints });
    }

    function confirmAddPoint() {
        const nome = document.getElementById('manualName').value;
        const obs = cleanObs(document.getElementById('manualObs').value);
        if (tempCoord && nome) {
            // Adiciona antes do √∫ltimo ponto (retorno)
            points.splice(points.length - 1, 0, { nome, obs, lat: tempCoord[0], lng: tempCoord[1] });
            
            // Limpa campos
            document.getElementById('confirmAdd').style.display = 'none';
            document.getElementById('addressSearch').value = '';
            document.getElementById('coordsInput').value = '';
            document.getElementById('manualName').value = '';
            document.getElementById('manualObs').value = '';
            tempCoord = null;
            
            updateUI(); calculateRoute();
        }
    }

    function saveObs(index) {
        points[index].obs = cleanObs(document.getElementById(`inline-obs-${index}`).value);
        updateUI(); showMarkers(); 
    }

    function updateUI() {
        const list = document.getElementById('stopList');
        list.innerHTML = '';
        points.forEach((p, i) => {
            const num = (i + 1).toString().padStart(2, '0');
            const isFirst = (i === 0), isLast = (i === points.length - 1);
            let cssClass = isFirst ? "fixed-base" : (isLast ? "fixed-end" : "");
            
            list.innerHTML += `
            <div class="stop-item ${cssClass}" data-index="${i}">
                <div class="stop-main">
                    <div class="stop-number" style="${isLast ? 'background:var(--red)' : ''}">${num}</div>
                    <div class="stop-info"><b>${p.nome}</b></div>
                </div>
                <div class="obs-edit-container">
                    <input type="text" class="input-obs-inline" id="inline-obs-${i}" value="${p.obs || ''}" placeholder="Obs...">
                    <button class="btn-save-obs" onclick="saveObs(${i})">üíæ</button>
                </div>
                ${(!isFirst && !isLast) ? `<button class="btn-del" onclick="removePoint(${i})">‚úï</button>` : ''}
            </div>`;
        });
        showMarkers();
    }

    function showMarkers() {
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];
        points.forEach((p, i) => {
            const num = (i + 1).toString().padStart(2, '0');
            const isFirst = (i === 0), isLast = (i === points.length - 1);
            const iconClass = isLast ? 'num-icon-end' : 'num-icon';
            
            const marker = L.marker([p.lat, p.lng], {
                icon: L.divIcon({ className: iconClass, html: num, iconSize: [24, 24] }),
                zIndexOffset: isFirst ? 1000 : (isLast ? 0 : 500),
                title: "Clique para abrir no Google Maps"
            }).addTo(map);

            // Link corrigido para padr√£o Google Maps
            marker.on('click', function() {
                window.open(`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`, '_blank');
            });

            const labelContent = `<b>${p.nome}</b>${p.obs ? '<br><span style="color:#D00; font-style:italic">' + p.obs + '</span>' : ''}`;
            let tooltipDir = isLast ? 'bottom' : 'top';
            let tooltipOffset = isLast ? [0, 10] : [0, -10];

            marker.bindTooltip(labelContent, { 
                permanent: true, direction: tooltipDir, className: 'custom-label', offset: tooltipOffset 
            });
            markers.push(marker);
        });
        if (points.length > 0) map.fitBounds(L.latLngBounds(points.map(p => [p.lat, p.lng])), {padding:[50,50]});
    }

    function calculateRoute() {
        if (points.length < 2) { 
            document.getElementById('summary-card').style.display = 'none';
            if (routingControl) { map.removeControl(routingControl); routingControl = null; }
            return; 
        }

        if (routingControl) { map.removeControl(routingControl); routingControl = null; }
        
        try {
            routingControl = L.Routing.control({
                waypoints: points.map(p => L.latLng(p.lat, p.lng)),
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'driving' }),
                createMarker: () => null, 
                show: true, 
                addWaypoints: false, 
                lineOptions: { styles: [{ color: '#4285F4', weight: 6, opacity: 0.6 }] }
            })
            .on('routesfound', function(e) {
                lastRouteData = e.routes[0];
                const distKm = (lastRouteData.summary.totalDistance / 1000).toFixed(1);
                const timeMin = Math.round(lastRouteData.summary.totalTime / 60);
                document.getElementById('total-dist').innerText = distKm + " km";
                document.getElementById('total-time').innerText = timeMin + " min";
                document.getElementById('summary-card').style.display = 'flex';
            })
            .on('routingerror', function(e) { console.warn('Erro rota:', e); })
            .addTo(map);
        } catch(err) { console.error(err); }
    }

    function optimizeRouteWithReturn() {
        if (points.length < 3) return alert("Adicione pontos intermedi√°rios para otimizar.");
        document.getElementById('loading').style.display = 'block';
        
        setTimeout(() => {
            // Algoritmo Vizinho Mais Pr√≥ximo + 2-Opt (Simples e Eficiente)
            const startNode = points[0];
            const endNode = points[points.length - 1];
            let middlePoints = points.slice(1, points.length - 1);
            let path = [startNode, endNode];
            
            // Constru√ß√£o Inicial
            while (middlePoints.length > 0) {
                let bestNodeIdx = -1, bestInsertPos = -1, minAddedCost = Infinity;
                for (let i = 0; i < middlePoints.length; i++) {
                    const node = middlePoints[i];
                    for (let j = 0; j < path.length - 1; j++) {
                        const p1 = path[j], p2 = path[j+1];
                        const addedCost = (Math.sqrt(distSq(p1, node)) + Math.sqrt(distSq(node, p2))) - Math.sqrt(distSq(p1, p2));
                        if (addedCost < minAddedCost) { minAddedCost = addedCost; bestNodeIdx = i; bestInsertPos = j + 1; }
                    }
                }
                path.splice(bestInsertPos, 0, middlePoints[bestNodeIdx]);
                middlePoints.splice(bestNodeIdx, 1);
            }

            // Otimiza√ß√£o 2-Opt
            let improved = true;
            while (improved) {
                improved = false;
                for (let i = 1; i < path.length - 2; i++) { 
                    for (let j = i + 1; j < path.length - 1; j++) {
                        const newPath = path.slice(0, i).concat(path.slice(i, j + 1).reverse()).concat(path.slice(j + 1));
                        if (calcTotalDist(newPath) < calcTotalDist(path)) { path = newPath; improved = true; }
                    }
                }
            }
            points = path; updateUI(); calculateRoute();
            document.getElementById('loading').style.display = 'none';
        }, 100);
    }

    function distSq(p1, p2) { return Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2); }
    function calcTotalDist(p) { let d = 0; for (let i = 0; i < p.length - 1; i++) d += Math.sqrt(distSq(p[i], p[i+1])); return d; }

    function reverseMiddleRoute() {
        if (points.length < 4) return;
        const middle = points.slice(1, points.length - 1).reverse();
        points = [points[0], ...middle, points[points.length - 1]];
        updateUI(); calculateRoute();
    }

    document.getElementById('csvFile').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            const lines = ev.target.result.split('\n').slice(1);
            lines.forEach(l => {
                if (!l.trim()) return;
                const sep = l.includes(';') ? ';' : ',';
                const c = l.replace(/"/g,'').split(sep);
                if (c.length >= 5) {
                    const lat = parseFloat(c[3].replace(',','.')), lng = parseFloat(c[4].replace(',','.'));
                    const rawObs = c.length > 5 ? c.slice(5).join(sep).trim() : "";
                    const obs = cleanObs(rawObs);
                    if (!isNaN(lat) && !isNaN(lng)) { 
                        points.splice(points.length - 1, 0, { nome: c[1], obs, lat, lng });
                    }
                }
            });
            updateUI(); calculateRoute();
        };
        reader.readAsText(e.target.files[0]);
    };

    function translateInstruction(text) {
        // Tradu√ß√µes manuais para manter o OSRM em PT-BR
        return text
            .replace(/Head/g, "Siga")
            .replace(/Turn right/g, "Vire √† direita")
            .replace(/Turn left/g, "Vire √† esquerda")
            .replace(/Make a U-turn/g, "Fa√ßa o retorno")
            .replace(/Continue/g, "Continue")
            .replace(/Arrive at/g, "Chegue em")
            .replace(/You have arrived/g, "Voc√™ chegou")
            .replace(/at your destination/g, "no destino")
            .replace(/on/g, "na");
    }

    function exportRouteToPDF() {
        if (!lastRouteData) return alert("Calcule a rota primeiro!");
        const win = window.open('', '_blank');
        let html = `<html><head><title>Rota Fermap</title><style>body{font-family:sans-serif;padding:20px} h1{border-bottom:2px solid #4285F4; color:#202124} table{width:100%;border-collapse:collapse;margin-top:15px} th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left} th{background:#4285F4;color:white} .summary{background:#f1f3f4;padding:15px;border-radius:8px}</style></head><body>`;
        html += `<h1>üöõ Relat√≥rio de Rota - Fermap</h1>`;
        html += `<div class="summary"><p><b>Dist√¢ncia Total:</b> ${(lastRouteData.summary.totalDistance/1000).toFixed(2)} km</p><p><b>Tempo Total:</b> ${Math.round(lastRouteData.summary.totalTime/60)} min</p></div>`;
        html += `<h3>üìç Paradas</h3><table><tr><th>#</th><th>Cliente</th><th>Obs</th></tr>`;
        points.forEach((p,i) => html += `<tr><td>${i+1}</td><td>${p.nome}</td><td>${p.obs || '-'}</td></tr>`);
        html += `</table><h3>üõ§Ô∏è Trajeto</h3><table>`;
        lastRouteData.instructions.forEach(inst => html += `<tr><td>${translateInstruction(inst.text)}</td><td>${inst.distance}m</td></tr>`);
        html += `</table></body></html>`;
        win.document.write(html); win.document.close(); win.print();
    }

    function removePoint(idx) { if (idx === 0 || idx === points.length - 1) return; points.splice(idx, 1); updateUI(); calculateRoute(); }
    
    function reorderPoints() {
        const newPoints = [];
        document.querySelectorAll('.stop-item').forEach(item => newPoints.push(points[parseInt(item.getAttribute('data-index'))]));
        points = newPoints; updateUI(); calculateRoute();
    }
    
    function resetMap() { points = [fermapStart, fermapEnd]; updateUI(); if (routingControl) { map.removeControl(routingControl); routingControl = null; } document.getElementById('summary-card').style.display='none'; }

    function sendToWhatsApp() {
        if (points.length < 2) return;
        
        // Link geral da rota (Google Maps Dire√ß√µes)
        let routeUrl = "https://www.google.com/maps/dir/";
        points.forEach(p => { routeUrl += `${p.lat},${p.lng}/`; });

        let msg = "üöõ *ROTA FERMAP*%0A%0Aüìç *Link da Rota:* " + encodeURIComponent(routeUrl) + "%0A%0A";
        
        points.forEach((p, i) => { 
            const linkPonto = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`;
            msg += `*${(i+1).toString().padStart(2,'0')}* - ${p.nome}%0A${p.obs ? 'üìù ' + p.obs + '%0A' : ''}üîó GPS: ${encodeURIComponent(linkPonto)}%0A%0A`;
        });
        
        window.open(`https://wa.me/?text=${msg}`);
    }

    window.onload = init;
</script>
</body>
</html>